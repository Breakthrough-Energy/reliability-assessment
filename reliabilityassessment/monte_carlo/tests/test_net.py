import numpy as np

from reliabilityassessment.monte_carlo.net import _net, net


def test_net():
    M = 30
    N = 38

    B = np.array(
        [
            0.00,
            525.00,
            0.00,
            0.00,
            0.00,
            486.00,
            525.00,
            506.00,
            506.00,
            126.00,
            300.00,
            1.00,
            300.00,
            300.00,
            300.00,
            300.00,
            1.00,
            300.00,
            300.00,
            300.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
        ]
    )

    B1 = np.array(
        [
            486.00,
            -525.00,
            506.00,
            506.00,
            126.00,
            486.00,
            525.00,
            506.00,
            506.00,
            126.00,
            300.00,
            1.00,
            300.00,
            300.00,
            300.00,
            300.00,
            1.00,
            300.00,
            300.00,
            300.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
            30000.00,
        ]
    )

    BS = np.array(
        [
            486.00,
            244.00,
            262.00,
            506.00,
            126.00,
            299.00,
            0.01,
            543.00,
            299.00,
            299.00,
            301.00,
            2.00,
            57.00,
            301.00,
            301.00,
            30000.00,
            30244.00,
            29756.00,
            30000.00,
            30000.00,
            30000.00,
            29756.00,
            30244.00,
            30000.00,
            30000.00,
            244.00,
            281.00,
            2.01,
            0.01,
            0.02,
        ]
    )

    IBAS = -1 + np.array(
        [
            14,
            15,
            16,
            17,
            18,
            19,
            8,
            21,
            22,
            23,
            24,
            25,
            26,
            27,
            28,
            29,
            30,
            31,
            32,
            33,
            34,
            35,
            36,
            37,
            38,
            11,
            10,
            3,
            1,
            6,
        ],
        dtype=int,
    )

    RES_true = np.array(
        [
            [0.01, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [2.01, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.02, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.01, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [244.00, 1.00, 0.00],
            [-244.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [281.00, 0.00, 0.00],
            [244.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [1.00, 0.00, 0.00],
            [1.00, 0.00, 0.00],
            [-243.00, 0.00, 0.00],
            [1.00, 0.00, 0.00],
            [1.00, 0.00, 0.00],
            [-1.00, 0.00, 0.00],
            [-1.00, 0.00, 0.00],
            [243.00, 0.00, 0.00],
            [-1.00, 0.00, 0.00],
            [-1.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [-244.00, 0.00, 0.00],
            [244.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [244.00, 0.00, 0.00],
            [-244.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
            [0.00, 0.00, 0.00],
        ]
    )

    # vanilla version works
    RES = np.zeros((N, 3))
    _net(B, B1, RES, IBAS, BS, M, N)
    np.testing.assert_array_almost_equal(RES, RES_true)

    # vectorized version does not work
    RES = np.zeros((N, 3))
    net(B, B1, RES, IBAS, BS, M, N)
    np.testing.assert_array_almost_equal(RES, RES_true)
